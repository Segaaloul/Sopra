Grafana (VM A)
    â”‚
    â”‚  ğŸ”” Alerte Prometheus (apache_up == 0)
    â”‚
    â–¼
Webhook HTTP (â†’ VM B :5001)
    â”‚
    â–¼
Serveur Flask (webhook_server.py)
    â”‚
    â–¼
Script shell (send_apache_log_to_teams.sh)
    â”‚
    â–¼
Microsoft Teams (via Webhook Teams)



ğŸ“‚ Fichiers utilisÃ©s
1. send_apache_log_to_teams.sh
ğŸ“ Chemin : /home/selim/send_apache_log_to_teams.sh
ğŸ”’ Donne les droits dâ€™exÃ©cution : chmod +x

#!/bin/bash

# âœ… ParamÃ¨tres
WEBHOOK_URL="https://steria.webhook.office.com/webhookb2/a10b2272-9e0a-4567-839a-304f461a9115@8b87af7d-8647-4dc7-8df4-5f69a2011bb5/IncomingWebhook/e1e6d96f4dcc43ce9321246a3af030f1/a563a265-5ae9-4c6c-a8d4-4fa4d176e600/V2SwaxA0aRmbCrWzt-wnG5FYx-K1_ErhCS2QrAbysb8NA1"
LOG_FILE="/var/log/apache2/error.log"
HOSTNAME=$(hostname)

# âœ… On rÃ©cupÃ¨re les 20 derniÃ¨res lignes de log
LOG=$(tail -n 20 "$LOG_FILE" | sed 's/"/\\"/g')

# âœ… On formate le message JSON pour Teams
MESSAGE="ğŸš¨ *Apache est DOWN sur le Serveur Sopra *

DerniÃ¨res lignes de /var/log/apache2/error.log :
\`\`\`
$LOG
\`\`\`"

# âœ… Envoi Ã  Teams via curl
curl -s -H "Content-Type: application/json" -X POST -d "{
  \"text\": \"$MESSAGE\"
}" "$WEBHOOK_URL"


# âœ… Envoi Ã  Teams via Webhook
curl -s -H "Content-Type: application/json" -X POST -d "{
  \"text\": \"$MESSAGE\"
}" "$WEBHOOK_URL"
2. webhook_server.py
ğŸ“ Chemin : /bin/webhook_server.py
ğŸ’¡ Sert Ã  recevoir l'alerte de Grafana via un webhook HTTP et dÃ©clencher le script.


from flask import Flask, request
import subprocess

app = Flask(__name__)

@app.route("/alert", methods=["POST"])
def alert():
    data = request.json
    print("Alerte reÃ§ue ! DonnÃ©es :")
    print(data)
    subprocess.Popen(["/home/selim/send_apache_log_to_teams.sh"])
    return "OK", 200

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5001)




ğŸ“Œ Configurations Ã  retenir

Dans Grafana-----
Contact Point : Webhook HTTP

URL : http://<IP_VM_B>:5001/alert

Content-Type : application/json

Rule dâ€™alerte :

Condition : apache_up == 0

AttachÃ©e Ã  ce Contact Point

ğŸ” Droits et sÃ©curitÃ©
Le fichier /var/log/apache2/error.log doit Ãªtre lisible : 
sudo chmod o+r /var/log/apache2/error.log


RÃ©sultat final
Lorsque le service Apache est down sur VM B :

Prometheus dÃ©tecte que apache_up == 0

Grafana envoie une alerte Ã  http://VM-B:5001/alert

Flask reÃ§oit lâ€™alerte, exÃ©cute send_apache_log_to_teams.sh

Le script lit les logs Apache et envoie un message enrichi sur Teams avec ğŸ”¥ les logs inclus




NB-----------------------------

dans la vm B jai installer pip pour ensuite installer flask




Amelioration

Jai cree un service pour flask , dans la vm B afin quil demarre automatiquement en tant que service

voici comment jai fais:
--- dans la vm B  ---
sudo nano /etc/systemd/system/flask_webhook.service


[Unit]
Description=Flask Webhook Server for Grafana Alerts
After=network.target

[Service]
User=selim
WorkingDirectory=/bin
ExecStart=/usr/bin/python3 /bin/webhook_server.py
Restart=always

[Install]
WantedBy=multi-user.target


sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl enable flask_webhook.service
sudo systemctl start flask_webhook.service
